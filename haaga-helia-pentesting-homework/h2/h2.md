# h2: Lisää vain vesi (add just water)

## x. Summaries
### Mastering Metasploit - Fourth Edition
#### Conducting a penetration test with Metasploit

`msfdb init` & `msfconsole` to initialize postgresql database and then start metasploit

Metasploit has 5 basic terms
- Exploit for exploitation
- Payload for post-exploitation
- Auxiliary for additional functions such as scanning, fuzzing, sniffing, etc.
- Encoders for obfuscation modules to avoid detection by firewalls or antiviruses
- Meterpreter is for remote control

Some example Metasploit commands:
<img src=h2.1.jpg alt=img>
<img src=h2.2.png alt=img>

Meterpreter commands:
<img src=h2.3.png alt=img>

- The reason metasploit is so popular is because it's open source
- Easy to use and natural naming conventions => can automate stuff easily
- Smart payload generation and switching using ```set payload```
- Cleaner exits by not crashing the target machine and exposing our trails
- It's much simpler to do fast checks to see if the target is vulnerable, without too much hassle => nmap and metasploit
- A SQL database where we can store our notes
<img src=h2.4.png alt=img>

- Custom workspaces with ```workspace``` command
- db_nmap and we can save nmap results to our tables, then ```hosts``` and ```services```

- Showing exploit methodology on a machine with port 445 open. ```db_nmap -Pn -sV``` flags allow us to get version and no-ping scan. We get to know it's a windows 7 machine with a `ms17.010` remote code execution vulnerability with a CVE identifier of 2017-0143.

- Choosing the right module and then exploiting based on quality such as `Excellent, Great, Good, Normal, Average, Low`

- Exploit explanation => then exploiting the vulnerability using `exploit/windows/smb/ms17_010_eternalblue` command then set RHOST to target machine with a reverse tcp shell payload for post-exploitation. 

- In post-exploitation, we use meterpreter for managing our remote session and can migrate our session to any active process to avoid detection

- incognito plugin in meterpreter allows us to impersonate any process

- We can then extract password hashes using smart_hashdump b using `usepost/windows/gather/smart_hashmp` and use kerberos and creds_all to get clear-text passwords on the machine

All in all a great case study to get an understanding of the depth a hack can get and how somethings could easily be automated once a malicious program gains access to your machine.


## a. Showing I have no internet connetion on my kali linux but have connections to one another

The machines have access to host-only network.
<img src=h2.5.png alt=img>
<img src=h2.6.png alt=img>

my network submask is 192.168.150.x so I will scan for machines up on this network by using 
`nmap -T4 -A 192.168.150.0/24`

found metasploitable on 192.168.150.5
<img src=h2.7.png alt=img>

## b. msfconsole initialized 
`msfdb init` then `msfconsole`
<img src=h2.8.png alt=img>

## c. db_nmap -sn 192.168.150.0/24

finding metasploitable again on port .5
<img src=h2.9.png alt=img>

## d. db_nmap -p- 192.168.150.5 for all tcp ports

`nmap -p- -oA foo 192.168.150.5` to save it as a file.
<img src=h2.10.png alt=img>

## e. `hosts` and `services` in msf

filtered by IP address. You can filter by port by doing `services -p 21` according to the manual
<img src=h2.11.png alt=img>

## f. difference between saved files and msfdb

I think saving as file is better for later if you want to run scripts that target multiple machines or ports or want to search for something from a file. Metasploit table is great for adding comments and notes while doing exploitation.

<img src=h2.12.png alt=img>

## g. exploiting vsftpd

First I searched for exploits on vsftpd using `search vsftpd`
<img src=h2.13.png alt=img>
It found an excellent backdoor command execution exploit.

`use exploit/unix/ftp/vsftpd_234_backdoor`

`options` to see the different options for this exploit
<img src=h2.14.png alt=img>

`help` to get some help with the commands

`set RHOST` to set the remote host target
<img src=h2.15.png alt=img>

`run` exploit and gaining shell access
<img src=h2.16.png alt=img>
You can then go back by making the session a background session with `Ctrl + Z`

## h. upgrading session to meterpreter in msf
`sessions -l` to list the available sessions in msf
`sessions -u <id>` to upgrade session to meterpreter

<img src=h2.17.png alt=img>

## i. Getting info on target machine
Wwe can use meterpreter session to get info on target machine by first opening session in meterpreter `session -i <id>`

Note that we should list sessions with `sessions -l` because meterpreter changes the id when you upgrade with it.

<img src=h2.18.png alt=img>
Now we can print ifconfig or whoami information. 

We can go to passwords folder and extract passwords.

According to a tutorial on Hackersploit on YouTube, you can run command such as `getprivs` to escalate privileges or `getuid`

`load incognito` and `list_tokens -u` for impersonation. However these commands do not work in Meterpreter type x86/linux for some reason so I was unable to test them.

<img src=h2.19.png alt=img>

## j. Another exploit into metasploitable

For another exploit I wanted try an HTTP port exploit on port 80. I was looking at blogs online about the different ports on Nmap and found out on Medium that Metasploitable is running Apache 2.2.8 on its HTTP port.

`search apache 2.2` in msfconsole. 28 exploits. Great. Let's try this `use exploit/linux/misc/nimbus_gettopologyhistory_cmd_exec`

<img src=h2.20.png alt=img>

set up RHOST to Metasploitable 2

it failed
<img src=h2.21.png alt=img>

Maybe I need to be more specific about the versioning and services that are run.

I was a bit frustrated at this point so I decided to look up a walkthrough online by Medium. I found one by Miguel Sampaio da Veiga on Port 80.

He used the exploit `use exploit/multi/http/php_cgi_arg_injection` I set the RHOST and LHOST and ran and it immediately gave me a meterpreter shell.

<img src=h2.22.png alt=img>

## k. Meterpreter features
You can do a lot of scripting in meterpreter. According to Barath on GetAstra.com
- you can upload malicious files to the victim machine using `upload` then file_path
- `Getuid` to know who you are logged in as and use that as information for privilege escalation
- you can use `ps` command on the target machine to see all running processes
- `run migrate` to change which process we can hide as in the victim machine
- `Getsystem` is a command that will try to bruteforce known privilege exploits against the target machine.
- `Hashdump` lets you retrieve password hashes from victim machine that are running  Windows. On linux you must navigate to `/etc/passwd` and `/etc/shadow` for the password and hashes respectively. Note that root privileges is required for reading shadow
- `clearev` can be used to clear all system, application and security logs on the victim machine
- `webcam_list` and `webcam_snap` can be used to display and take pictures on target machine's webcam. You can use `webcam_stream` to display live video. 

(Webasha.com)

## l. Save shell save to txt file
You can use `script -fa log001.txt` to record your terminal.

The file is stored in my working directorys but it only records everything after you have entered it. It does not record any inputs before it is run.

<img src=h2.24.png alt=img>

## bonus 1. Cracking metasploitable 3?



## References

Rapid7 docs:
https://github.com/rapid7/metasploit-framework/wiki

Jaswal, Nipun. Mastering Metasploit – Fourth Edition. Packt Publishing via O’Reilly, June 2020, https://learning.oreilly.com/library/view/mastering-metasploit/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-31

Nmap cheatsheet:
https://www.stationx.net/nmap-cheat-sheet/

vsftpd backdoor by Rapid7:
https://www.rapid7.com/db/modules/exploit/unix/ftp/vsftpd_234_backdoor/

Meterpreter docs:
https://docs.metasploit.com/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html

Offsec Meterpreter guide
https://www.offsec.com/metasploit-unleashed/meterpreter-basics/

Oreilly - MSF console background command
https://learning.oreilly.com/library/view/mastering-metasploit/9781788990615/7c3b3c51-1095-4ed2-8f4e-5652a6c5a649.xhtml

Hackersploit Lateral Movement
https://www.youtube.com/watch?v=QGkmlsvjMYI

Medium Exploring Open Ports in Metasploitable2
https://medium.com/%40messumzaidi512/exploring-open-ports-and-vulnerabilities-in-metasploitable2-using-nmap-445eb0d17379


Medium Miguel Sampaio da Veiga
https://medium.com/hacker-toolbelt/metasploitable-2-iv-port-80-5b90a0a22cb6

Medium Anshuman Understanding /etc/passwd and /etc/shadow Files
https://medium.com/@The_Anshuman/understanding-etc-passwd-and-etc-shadow-files-58630eb0eda8

Webasha A Step-by-Step Guide to Webcam Exploitation in a Lab Setup
https://www.webasha.com/blog/a-step-by-step-guide-to-webcam-exploitation-in-a-lab-setup

ScienceDirect.com
https://www.sciencedirect.com/topics/computer-science/meterpreter-shell

GetAstra.com Meterpreter Commands
https://www.getastra.com/blog/security-audit/meterpreter-commands-post-exploitation/
